<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Caja Secreta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 1.6em;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .progress-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.5;
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            font-size: 15px;
            animation: fadeInUp 0.3s ease;
            opacity: 0;
            animation-fill-mode: forwards;
            position: relative;
        }

        .message.bot {
            background: #e3f2fd;
            color: #1565c0;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .message.user.editable:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .edit-icon {
            position: absolute;
            top: 5px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 12px;
            font-weight: 300;
        }

        .message.user.editable:hover .edit-icon {
            opacity: 0.8;
        }

        /* Estilos para el modo de edici√≥n inline */
        .edit-mode {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.3s ease;
        }

        .edit-mode input,
        .edit-mode textarea,
        .edit-mode .radio-group,
        .edit-mode .checkbox-group {
            margin-bottom: 10px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .edit-actions button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        /* Jerarqu√≠a tipogr√°fica dentro de los mensajes */
        .message h2 {
            font-size: 1.3em;
            font-weight: 700;
            margin: 0 0 15px 0;
            color: inherit;
            line-height: 1.3;
        }

        .message h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 15px 0 10px 0;
            color: inherit;
        }

        .message p {
            margin: 0 0 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .message em {
            font-style: italic;
            font-weight: 300;
            font-size: 13px;
            opacity: 0.8;
        }

        .message strong {
            font-weight: 600;
            color: inherit;
        }

        .message ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .message li {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            min-height: 80px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            transition: border-color 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            resize: none;
            line-height: 1.5;
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: #999;
            font-weight: 300;
            font-style: italic;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            border-radius: 15px;
            min-height: 100px;
            max-height: 200px;
            padding: 14px 18px;
            overflow-y: auto;
            resize: none;
        }

        .textarea-container {
            position: relative;
        }

        .character-counter {
            margin-top: 8px;
            font-size: 12px;
            font-style: italic;
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            text-align: right;
            line-height: 1.3;
            padding-right: 5px;
        }

        .character-counter.insufficient {
            color: #e74c3c;
        }

        .character-counter.sufficient {
            color: #27ae60;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: flex-start;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .radio-option:hover,
        .checkbox-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-option input,
        .checkbox-option input {
            margin-right: 10px;
            margin-top: 3px;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .radio-option.selected,
        .checkbox-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .radio-option label,
        .checkbox-option label {
            font-size: 13px;
            line-height: 1.3;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .summary-section {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .summary-section h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        .summary-value {
            color: #333;
            font-size: 14px;
            max-width: 60%;
            text-align: right;
        }

        .summary-value.truncated {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #e3f2fd;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 85%;
            align-self: flex-start;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #1565c0;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 8px;
            padding-left: 18px;
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            line-height: 1.4;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            
            .message {
                max-width: 90%;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-header h1 {
                font-size: 1.3em;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .input-area {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .radio-option,
            .checkbox-option {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .orientation-option {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .orientation-option label {
                font-size: 11px;
                line-height: 1.2;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                padding: 12px;
            }
            
            .chat-header h1 {
                font-size: 1.2em;
            }
            
            .progress-indicator {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .message {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .chat-messages {
                padding: 12px;
            }
            
            .input-area {
                padding: 12px;
            }
            
            .input-group input,
            .input-group textarea {
                font-size: 16px; /* Previene zoom en iOS */
                padding: 10px 12px;
            }
            
            .input-group textarea {
                min-height: 80px;
                max-height: 160px;
            }
            
            .character-counter {
                font-size: 10px;
                padding-right: 3px;
                margin-top: 6px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 12px;
            }
            
            .action-buttons {
                gap: 8px;
            }
            
            .radio-option,
            .checkbox-option {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .orientation-option {
                padding: 5px 8px;
                font-size: 10px;
            }
            
            .orientation-option label {
                font-size: 10px;
                line-height: 1.1;
            }
            
            .error-message {
                font-size: 11px;
                padding-left: 12px;
                margin-top: 6px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-container {
                max-width: 600px;
                height: 700px;
            }
        }

        @media (min-width: 1025px) {
            .chat-container {
                max-width: 550px;
                height: 650px;
            }
        }

        /* Estilos espec√≠ficos para orientaci√≥n sexual */
        .orientation-option {
            padding: 8px 12px;
            margin: 2px 0;
            font-size: 12px;
        }

        .orientation-option label {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>La Caja Secreta</h1>
            <div class="progress-indicator">
                <span id="progressText">1 / 7</span>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Los mensajes aparecer√°n aqu√≠ din√°micamente -->
        </div>

        <div class="input-area" id="inputArea">
            <!-- El √°rea de input cambiar√° seg√∫n la pregunta -->
        </div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 7;
        let messageHistory = [];
        let editingMessageIndex = null;
        
        const formData = {
            acceptTerms: false,
            name: '',
            email: '',
            gender: '',
            orientation: '',
            story: '',
            timestamp: new Date().toISOString()
        };

        const questions = [
            {
                id: 'terms',
                type: 'checkbox',
                message: `<h2>¬øTienes esa historia que nunca te atreviste a contar?</h2>
                <p>Ahora es tu momento. Comparte conmigo ese secreto, esa an√©cdota personal, esa experiencia que guardaste para ti, <strong>Soy La Caja Secreta</strong> en tu caj√≥n del closet. No te preocupes por tu privacidad: este proyecto est√° dise√±ado para proteger tu identidad de manera absoluta.</p>
                <p>Al ingresar tus datos y participar, aceptas nuestros <strong>t√©rminos y condiciones</strong>, los cuales garantizan que:</p>
                <ul>
                    <li>‚úÖ <strong>Tu identidad nunca ser√° revelada</strong> de manera intencional</li>
                    <li>‚úÖ <strong>Tus datos personales permanecer√°n confidenciales</strong> y protegidos</li>
                    <li>‚úÖ <strong>Solo necesitamos tu correo electr√≥nico</strong> para crear y enviarte tu texto</li>
                    <li>‚úÖ <strong>Tu historia ser√° compartida de forma completamente an√≥nima</strong></li>
                </ul>
                <h3>¬øQu√© significa participar?</h3>
                <p>Tu participaci√≥n implica que est√°s dispuesto/a a <strong>"sacar alg√∫n trapito al sol"</strong> de manera an√≥nima. Tu historia se convertir√° en parte de una colecci√≥n po√©tica de experiencias humanas reales, pero siempre sin revelar qui√©n eres.</p>
                <p><strong>Recuerda:</strong> Una vez que compartas tu historia, esta formar√° parte del proyecto de manera an√≥nima. Tu identidad estar√° protegida, pero tu experiencia ayudar√° a crear algo √∫nico y aut√©ntico.</p>
                <p><em>Si no est√°s de acuerdo, cierra la ventana, de lo contrario acepta los t√©rminos y continuemos.</em></p>`,
                options: [
                    { value: 'accept', label: 'Acepto los t√©rminos y condiciones' }
                ],
                required: true,
                buttonText: 'Aceptar y continuar'
            },
            {
                id: 'name',
                type: 'text',
                message: `<h2>Dime tu nombre o como te dicen tus amigos</h2>
                <p><em>Lo usar√© para no crear una historia por coincidencia con el tuyo</em></p>`,
                placeholder: 'Escribe tu nombre o apodo...',
                required: true,
                buttonText: 'Continuar'
            },
            {
                id: 'email',
                type: 'email',
                message: `<h2>¬øPodr√≠as darme tu direcci√≥n de correo electr√≥nico?</h2>
                <p><em>Solo necesitamos tu correo electr√≥nico para crear y enviarte tu texto.</em></p>`,
                placeholder: 'correo@ejemplo.com',
                required: true,
                buttonText: 'Continuar'
            },
            {
                id: 'gender',
                type: 'radio',
                message: `<h2>G√©nero</h2>
                <p><em>Lo usar√© para redactar el texto con los pronombres adecuados.</em></p>`,
                options: [
                    { value: 'masculino', label: 'Masculino' },
                    { value: 'femenino', label: 'Femenino' },
                    { value: 'neutro', label: 'Neutro' }
                ],
                required: true,
                buttonText: 'Continuar'
            },
            {
                id: 'orientation',
                type: 'radio',
                message: `<h2>Orientaci√≥n sexual</h2>
                <p><em>Si decides compartirlo conmigo, podr√© utilizarlo para analizar la participaci√≥n global y comprender mejor sus dolores emocionales como humanos diversos.</em></p>`,
                options: [
                    { value: 'heterosexual', label: '<strong>Heterosexual:</strong> personas atra√≠das afectiva y er√≥ticamente hacia personas del sexo opuesto.' },
                    { value: 'homosexual', label: '<strong>Homosexual:</strong> personas atra√≠das afectiva y er√≥ticamente hacia personas del mismo sexo.' },
                    { value: 'bisexual', label: '<strong>Bisexual:</strong> personas atra√≠das afectiva y er√≥ticamente hacia personas del mismo sexo y/o del sexo opuesto.' },
                    { value: 'pansexual', label: '<strong>Pansexual:</strong> personas atra√≠das afectiva y er√≥ticamente hacia otras, sin importar sexo, g√©nero o identidad.' },
                    { value: 'asexual', label: '<strong>Asexual:</strong> personas sin atracci√≥n sexual y/o que no desean contacto sexual, parcial o totalmente.' },
                    { value: 'demisexual', label: '<strong>Demisexual:</strong> personas atra√≠das afectiva y er√≥ticamente solo tras formar un v√≠nculo emocional.' }
                ],
                required: false,
                buttonText: 'Continuar'
            },
            {
                id: 'story',
                type: 'textarea',
                message: `<h2>Tu historia secreta</h2>
                <p><em>Este es un espacio seguro para que compartas aquello que no sueles decir en voz alta. Ten la tranquilidad de que lo que escribas aqu√≠ no ser√° divulgado, difundido ni compartido de forma literal.</em></p>
                <p><em>Crear√© un texto que represente tu historia de manera √∫nica, utilizando met√°foras y recursos literarios, para que solo t√∫ sepas que es tu experiencia, mientras otros puedan conectar con ella desde su propia perspectiva. Puede ser tan corta o larga como quieras.</em></p>`,
                placeholder: 'Comparte tu historia secreta aqu√≠...',
                required: true,
                buttonText: 'Continuar'
            },
            {
                id: 'thanks',
                type: 'final',
                message: `<h2>¬°Gracias por compartir conmigo tu historia secreta!</h2>
                <p>Has guardado en un lugar seguro y confidencial aquello que a√∫n no puedes contar al mundo o no tuviste la oportunidad.</p>
                <p><em>En breve recibir√°s un correo con mi interpretaci√≥n para ti.</em></p>`,
                buttonText: 'Enviar mi historia'
            }
        ];

        function addMessage(content, type = 'bot', delay = 0, questionId = null) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;
                    messageDiv.innerHTML = content;
                    
                    // Guardar informaci√≥n en el historial
                    const messageIndex = messageHistory.length;
                    messageHistory.push({
                        content: content,
                        type: type,
                        questionId: questionId,
                        element: messageDiv
                    });
                    
                    // Hacer editables las respuestas del usuario (excepto el mensaje final)
                    if (type === 'user' && questionId && questionId !== 'thanks') {
                        messageDiv.classList.add('editable');
                        messageDiv.dataset.messageIndex = messageIndex;
                        messageDiv.dataset.questionId = questionId;
                        messageDiv.innerHTML += '<span class="edit-icon">‚úèÔ∏è Editar</span>';
                        messageDiv.addEventListener('click', () => editMessage(messageIndex));
                    }
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    resolve();
                }, delay);
            });
        }

        function editMessage(messageIndex) {
            const message = messageHistory[messageIndex];
            if (!message || message.type !== 'user' || editingMessageIndex !== null) return;
            
            editingMessageIndex = messageIndex;
            const questionId = message.questionId;
            const question = questions.find(q => q.id === questionId);
            
            // Crear el √°rea de edici√≥n
            const editDiv = document.createElement('div');
            editDiv.className = 'edit-mode';
            
            if (question.type === 'text' || question.type === 'email') {
                editDiv.innerHTML = `
                    <input type="${question.type}" id="editInput" value="${formData[questionId]}" placeholder="${question.placeholder}">
                    <div class="edit-actions">
                        <button class="btn btn-secondary" onclick="cancelEdit()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveEdit('${questionId}')">Guardar</button>
                    </div>
                `;
            } else if (question.type === 'textarea') {
                editDiv.innerHTML = `
                    <textarea id="editInput" placeholder="${question.placeholder}">${formData[questionId]}</textarea>
                    ${questionId === 'story' ? '<div class="character-counter" id="editCharCounter"></div>' : ''}
                    <div class="edit-actions">
                        <button class="btn btn-secondary" onclick="cancelEdit()">Cancelar</button>
                        <button class="btn btn-primary" id="editSaveBtn" onclick="saveEdit('${questionId}')">Guardar</button>
                    </div>
                `;
                
                // Configurar el contador de caracteres si es necesario
                setTimeout(() => {
                    if (questionId === 'story') {
                        const textarea = document.getElementById('editInput');
                        const charCounter = document.getElementById('editCharCounter');
                        const saveBtn = document.getElementById('editSaveBtn');
                        
                        function updateCounter() {
                            const currentLength = textarea.value.length;
                            if (currentLength < 140) {
                                charCounter.textContent = `${140 - currentLength} caracteres restantes`;
                                charCounter.className = 'character-counter insufficient';
                                saveBtn.disabled = true;
                            } else {
                                charCounter.textContent = `${currentLength} caracteres`;
                                charCounter.className = 'character-counter sufficient';
                                saveBtn.disabled = false;
                            }
                        }
                        
                        textarea.addEventListener('input', updateCounter);
                        updateCounter();
                    }
                }, 10);
            } else if (question.type === 'radio') {
                const optionsHtml = question.options.map((option, index) => `
                    <div class="radio-option ${question.id === 'orientation' ? 'orientation-option' : ''} ${formData[questionId] === option.value ? 'selected' : ''}" onclick="selectEditOption('${option.value}', 'radio', '${questionId}')">
                        <input type="radio" name="editRadio" value="${option.value}" id="edit_option_${index}" ${formData[questionId] === option.value ? 'checked' : ''}>
                        <label for="edit_option_${index}">${option.label}</label>
                    </div>
                `).join('');
                
                editDiv.innerHTML = `
                    <div class="radio-group">
                        ${optionsHtml}
                    </div>
                    <div class="edit-actions">
                        <button class="btn btn-secondary" onclick="cancelEdit()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveEdit('${questionId}')">Guardar</button>
                    </div>
                `;
            }
            
            // Insertar el √°rea de edici√≥n despu√©s del mensaje
            message.element.parentNode.insertBefore(editDiv, message.element.nextSibling);
            
            // Ocultar el mensaje original
            message.element.style.display = 'none';
            
            // Focus en el input
            setTimeout(() => {
                const input = document.getElementById('editInput');
                if (input) input.focus();
            }, 100);
        }

        function selectEditOption(value, type, questionId) {
            if (type === 'radio') {
                document.querySelectorAll('.edit-mode .radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                const radio = event.currentTarget.querySelector('input[type="radio"]');
                radio.checked = true;
            }
        }

        function cancelEdit() {
            if (editingMessageIndex === null) return;
            
            const message = messageHistory[editingMessageIndex];
            const editDiv = message.element.nextSibling;
            
            if (editDiv && editDiv.classList.contains('edit-mode')) {
                editDiv.remove();
            }
            
            message.element.style.display = '';
            editingMessageIndex = null;
        }

        function saveEdit(questionId) {
            if (editingMessageIndex === null) return;
            
            const message = messageHistory[editingMessageIndex];
            const question = questions.find(q => q.id === questionId);
            let newValue = '';
            
            if (question.type === 'text' || question.type === 'email' || question.type === 'textarea') {
                const input = document.getElementById('editInput');
                newValue = input.value.trim();
                
                // Validaciones
                if (question.required && !newValue) {
                    alert('Este campo es obligatorio.');
                    return;
                }
                
                if (question.type === 'email' && newValue) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(newValue)) {
                        alert('Por favor, ingresa un correo electr√≥nico v√°lido.');
                        return;
                    }
                }
                
                if (questionId === 'story' && newValue.length < 140) {
                    alert('La historia debe tener al menos 140 caracteres.');
                    return;
                }
            } else if (question.type === 'radio') {
                const selected = document.querySelector('.edit-mode input[name="editRadio"]:checked');
                if (!selected && question.required) {
                    alert('Por favor selecciona una opci√≥n.');
                    return;
                }
                newValue = selected ? selected.value : '';
            }
            
            // Actualizar el valor en formData
            formData[questionId] = newValue;
            
            // Actualizar el mensaje en pantalla
            let displayValue = newValue;
            if (question.type === 'radio' && newValue) {
                const option = question.options.find(opt => opt.value === newValue);
                displayValue = option ? option.label.replace(/<[^>]*>?/gm, '') : newValue;
            }
            
            message.content = displayValue;
            message.element.innerHTML = displayValue + '<span class="edit-icon">‚úèÔ∏è Editar</span>';
            
            // Limpiar la edici√≥n
            cancelEdit();
        }

        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return typingDiv;
        }

        function removeTyping(typingElement) {
            if (typingElement && typingElement.parentNode) {
                typingElement.parentNode.removeChild(typingElement);
            }
        }

        function updateProgress() {
            document.getElementById('progressText').textContent = `${currentStep + 1} / ${totalSteps}`;
        }

        function createInputArea(question) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';

            if (question.type === 'text' || question.type === 'email') {
                inputArea.innerHTML = `
                    <div class="input-group">
                        <input type="${question.type}" id="currentInput" placeholder="${question.placeholder}" ${question.required ? 'required' : ''} value="${formData[question.id] || ''}">
                        <div class="error-message" id="errorMessage"></div>
                    </div>
                    <div class="action-buttons">
                        ${currentStep > 0 ? '<button type="button" class="btn btn-secondary" onclick="goBack()">Anterior</button>' : ''}
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="processAnswer()" ${formData[question.id] ? '' : 'disabled'}>${question.buttonText}</button>
                    </div>
                `;

                const input = document.getElementById('currentInput');
                input.addEventListener('input', () => {
                    const nextBtn = document.getElementById('nextBtn');
                    if (question.required) {
                        nextBtn.disabled = !input.value.trim();
                    } else {
                        nextBtn.disabled = false;
                    }
                    document.getElementById('errorMessage').textContent = '';
                });

                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !document.getElementById('nextBtn').disabled) {
                        processAnswer();
                    }
                });

                input.focus();

            } else if (question.type === 'textarea') {
                inputArea.innerHTML = `
                    <div class="input-group">
                        <div class="textarea-container">
                            <textarea id="currentInput" placeholder="${question.placeholder}" ${question.required ? 'required' : ''}>${formData[question.id] || ''}</textarea>
                        </div>
                        ${question.id === 'story' ? '<div class="character-counter" id="charCounter"></div>' : ''}
                        <div class="error-message" id="errorMessage"></div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">Anterior</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="processAnswer()" ${formData[question.id] && formData[question.id].length >= 140 ? '' : 'disabled'}>${question.buttonText}</button>
                    </div>
                `;

                const textarea = document.getElementById('currentInput');
                const charCounter = document.getElementById('charCounter');
                
                function adjustTextareaHeight() {
                    textarea.style.height = '100px';
                    const scrollHeight = textarea.scrollHeight;
                    const minHeight = 100;
                    const maxHeight = 200;
                    
                    if (scrollHeight <= maxHeight) {
                        textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
                        textarea.style.overflowY = 'hidden';
                    } else {
                        textarea.style.height = maxHeight + 'px';
                        textarea.style.overflowY = 'auto';
                    }
                }
                
                function updateCharacterCounter() {
                    const currentLength = textarea.value.length;
                    const nextBtn = document.getElementById('nextBtn');
                    
                    if (question.id === 'story') {
                        if (currentLength < 140) {
                            const remaining = 140 - currentLength;
                            charCounter.textContent = `${remaining} caracteres restantes`;
                            charCounter.className = 'character-counter insufficient';
                            nextBtn.disabled = true;
                        } else {
                            charCounter.textContent = `${currentLength} caracteres - Sigue escribiendo lo que necesites, estoy aqu√≠ para leerte y luego interpretarte`;
                            charCounter.className = 'character-counter sufficient';
                            nextBtn.disabled = false;
                        }
                        
                        adjustTextareaHeight();
                    } else {
                        nextBtn.disabled = question.required && !textarea.value.trim();
                    }
                    document.getElementById('errorMessage').textContent = '';
                }
                
                textarea.addEventListener('input', updateCharacterCounter);
                textarea.addEventListener('paste', () => {
                    setTimeout(updateCharacterCounter, 10);
                });
                
                if (question.id === 'story') {
                    updateCharacterCounter();
                }

                textarea.addEventListener('keypress', (e) => {
                    if ((e.key === 'Enter' && e.ctrlKey) && !document.getElementById('nextBtn').disabled) {
                        processAnswer();
                    }
                });

                textarea.focus();

            } else if (question.type === 'radio') {
                const optionsHtml = question.options.map((option, index) => `
                    <div class="radio-option ${question.id === 'orientation' ? 'orientation-option' : ''} ${formData[question.id] === option.value ? 'selected' : ''}" onclick="selectOption('${option.value}', 'radio')">
                        <input type="radio" name="currentRadio" value="${option.value}" id="option_${index}" ${formData[question.id] === option.value ? 'checked' : ''}>
                        <label for="option_${index}">${option.label}</label>
                    </div>
                `).join('');

                inputArea.innerHTML = `
                    <div class="radio-group">
                        ${optionsHtml}
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">Anterior</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="processAnswer()" ${!question.required || formData[question.id] ? '' : 'disabled'}>${question.buttonText}</button>
                    </div>
                `;

            } else if (question.type === 'checkbox') {
                const optionsHtml = question.options.map((option, index) => `
                    <div class="checkbox-option ${formData.acceptTerms ? 'selected' : ''}" onclick="selectOption('${option.value}', 'checkbox')">
                        <input type="checkbox" name="currentCheckbox" value="${option.value}" id="option_${index}" ${formData.acceptTerms ? 'checked' : ''}>
                        <label for="option_${index}">${option.label}</label>
                    </div>
                `).join('');

                inputArea.innerHTML = `
                    <div class="checkbox-group">
                        ${optionsHtml}
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="processAnswer()" ${formData.acceptTerms ? '' : 'disabled'}>${question.buttonText}</button>
                    </div>
                `;

            } else if (question.type === 'final') {
                // Mostrar resumen antes del env√≠o
                const summaryHtml = `
                    <div class="summary-section">
                        <h3>Resumen de tu informaci√≥n</h3>
                        <div class="summary-item">
                            <span class="summary-label">Nombre:</span>
                            <span class="summary-value">${formData.name}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Email:</span>
                            <span class="summary-value">${formData.email}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">G√©nero:</span>
                            <span class="summary-value">${formData.gender}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Orientaci√≥n:</span>
                            <span class="summary-value">${formData.orientation || 'No especificada'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Historia:</span>
                            <span class="summary-value truncated">${formData.story.substring(0, 50)}${formData.story.length > 50 ? '...' : ''}</span>
                        </div>
                    </div>
                `;
                
                inputArea.innerHTML = summaryHtml + `
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="submitForm()">${question.buttonText}</button>
                    </div>
                `;
            }
        }

        function selectOption(value, type) {
            if (type === 'radio') {
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                
                const radio = event.currentTarget.querySelector('input[type="radio"]');
                radio.checked = true;
                
                document.getElementById('nextBtn').disabled = false;

            } else if (type === 'checkbox') {
                const checkbox = event.currentTarget.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    event.currentTarget.classList.add('selected');
                } else {
                    event.currentTarget.classList.remove('selected');
                }
                
                const anyChecked = document.querySelectorAll('input[name="currentCheckbox"]:checked').length > 0;
                document.getElementById('nextBtn').disabled = !anyChecked;
            }
        }

        function validateCurrentStep() {
            const question = questions[currentStep];
            
            if (question.type === 'text' || question.type === 'email') {
                const input = document.getElementById('currentInput');
                const value = input.value.trim();
                
                if (question.required && !value) {
                    document.getElementById('errorMessage').textContent = 'Este campo es obligatorio.';
                    return false;
                }
                
                if (question.type === 'email' && value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        document.getElementById('errorMessage').textContent = 'Por favor, ingresa un correo electr√≥nico v√°lido.';
                        return false;
                    }
                }
                
                formData[question.id] = value;
                return true;

            } else if (question.type === 'textarea') {
                const textarea = document.getElementById('currentInput');
                const value = textarea.value.trim();
                
                if (question.required && !value) {
                    document.getElementById('errorMessage').textContent = 'Por favor, comparte tu historia.';
                    return false;
                }
                
                if (question.id === 'story' && value.length < 140) {
                    document.getElementById('errorMessage').textContent = '¬°Ups! Con tan pocos detalles me falta inspiraci√≥n. Al menos con 140 caracteres podr√≠a crear un lindo mensaje, pero con menos no puedo hacer un buen poema.';
                    return false;
                }
                
                formData[question.id] = value;
                return true;

            } else if (question.type === 'radio') {
                const selected = document.querySelector('input[name="currentRadio"]:checked');
                
                if (question.required && !selected) {
                    return false;
                }
                
                formData[question.id] = selected ? selected.value : '';
                return true;

            } else if (question.type === 'checkbox') {
                const selected = document.querySelectorAll('input[name="currentCheckbox"]:checked');
                
                if (question.required && selected.length === 0) {
                    return false;
                }
                
                if (question.id === 'terms') {
                    formData.acceptTerms = selected.length > 0;
                }
                
                return true;
            }
            
            return true;
        }

        async function processAnswer() {
            if (!validateCurrentStep()) {
                return;
            }

            let userResponse = '';
            const question = questions[currentStep];
            
            if (question.type === 'text' || question.type === 'email' || question.type === 'textarea') {
                userResponse = document.getElementById('currentInput').value;
            } else if (question.type === 'radio') {
                const selected = document.querySelector('input[name="currentRadio"]:checked');
                userResponse = selected ? selected.nextElementSibling.textContent : '';
            } else if (question.type === 'checkbox') {
                userResponse = 'T√©rminos aceptados ‚úì';
            }

            if (userResponse && question.type !== 'final') {
                await addMessage(userResponse, 'user', 0, question.id);
            }

            currentStep++;
            updateProgress();

            if (currentStep < questions.length) {
                setTimeout(() => {
                    const typing = showTyping();
                    setTimeout(() => {
                        removeTyping(typing);
                        addMessage(questions[currentStep].message);
                        createInputArea(questions[currentStep]);
                    }, 1500);
                }, 500);
            }
        }

        function goBack() {
            if (currentStep > 0) {
                currentStep--;
                updateProgress();
                createInputArea(questions[currentStep]);
            }
        }

        function submitForm() {
            console.log('Datos del formulario:', formData);
            
            const userResponse = 'Historia enviada ‚úì';
            addMessage(userResponse, 'user');
            
            setTimeout(() => {
                const typing = showTyping();
                setTimeout(() => {
                    removeTyping(typing);
                    addMessage('¬°Perfecto! Tu historia ha sido recibida de manera segura y confidencial. En unos instantes recibir√°s tu interpretaci√≥n po√©tica por correo electr√≥nico. ¬°Gracias por confiar en La Caja Secreta! üí´');
                    
                    // Aqu√≠ ir√≠a la conexi√≥n con Google Sheets
                    // submitToGoogleSheets(formData);
                    
                    setTimeout(() => {
                        addMessage('¬øTe gustar√≠a compartir otra historia secreta? üóùÔ∏è', 'bot');
                        
                        const inputArea = document.getElementById('inputArea');
                        inputArea.innerHTML = `
                            <div class="action-buttons">
                                <button type="button" class="btn btn-secondary" onclick="finishSession()">Finalizar</button>
                                <button type="button" class="btn btn-primary" onclick="startNewForm()">Nueva historia</button>
                            </div>
                        `;
                    }, 2000);
                    
                }, 1500);
            }, 500);
        }

        function startNewForm() {
            formData.acceptTerms = false;
            formData.name = '';
            formData.email = '';
            formData.gender = '';
            formData.orientation = '';
            formData.story = '';
            formData.timestamp = new Date().toISOString();
            
            currentStep = 0;
            messageHistory = [];
            editingMessageIndex = null;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            addMessage('¬°Hola de nuevo! Bienvenido/a otra vez a La Caja Secreta üóùÔ∏è', 'bot', 500);
            setTimeout(() => {
                const typing = showTyping();
                setTimeout(() => {
                    removeTyping(typing);
                    addMessage(questions[0].message);
                    createInputArea(questions[0]);
                    updateProgress();
                }, 2000);
            }, 1000);
        }

        function finishSession() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';
            
            addMessage('¬°Que tengas un hermoso d√≠a! Fue un placer ser tu caja secreta. üí´‚ú®', 'bot');
            
            setTimeout(() => {
                const inputArea = document.getElementById('inputArea');
                inputArea.innerHTML = `
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" onclick="startNewForm()">Compartir una nueva historia</button>
                    </div>
                `;
            }, 3000);
        }

        function submitToGoogleSheets(data) {
            // Aqu√≠ va la implementaci√≥n de Google Sheets API
            console.log('Enviando a Google Sheets:', data);
        }

        function initChat() {
            addMessage('¬°Hola! Bienvenido/a a La Caja Secreta üóùÔ∏è', 'bot', 500);
            setTimeout(() => {
                const typing = showTyping();
                setTimeout(() => {
                    removeTyping(typing);
                    addMessage(questions[0].message);
                    createInputArea(questions[0]);
                    updateProgress();
                }, 2000);
            }, 1000);
        }

        initChat();
    </script>
</body>
</html>