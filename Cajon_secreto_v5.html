<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Cajón Secreto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Caveat:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #2b2019;
            --card-bg: #F1EDFF;
            --card-text: #4B3C81;
            --accent-color: #a48976;
            --header-text: #fdfaf4;
            --btn-bg: linear-gradient(135deg, #7a6252, #5f4a3e);
            --marker-color: #d9534f;
            --grid-color: #E1DDF0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: white;
        }

        #app-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-top: 20px;
        }

        #parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .parallax-item {
            position: absolute;
            transition: transform 0.2s ease-out;
            will-change: transform;
        }

        #card-stage {
            flex-grow: 1;
            position: relative;
            perspective: 1500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 120px;
            z-index: 2;
        }

        .card {
            position: absolute;
            width: 90%;
            max-width: 480px;
            padding: 35px 40px;
            background-color: var(--card-bg);
            color: var(--card-text);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.8s ease;
            opacity: 0;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            transform: translateZ(-800px) rotateY(30deg) scale(0.8);
            clip-path: url(#torn-paper);
            
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .card::before { /* Notebook holes */
            content: '';
            position: absolute;
            top: 0;
            left: 15px;
            bottom: 0;
            width: 2px;
            background-image: 
                radial-gradient(circle at center, transparent 3px, var(--card-bg) 3px, var(--card-bg) 5px, transparent 5px),
                linear-gradient(to bottom, transparent, transparent);
            background-size: 100% 20px;
        }

        .card.is-active {
            opacity: 1;
            z-index: 1;
            transform: translateZ(0) rotateY(0deg) scale(1);
        }

        .card.is-exiting {
            opacity: 0;
            transform: translateZ(-400px) scale(0.9);
        }
        
        .card h2 { font-family: 'Caveat', cursive; color: var(--card-text); font-size: 2em; margin-bottom: 15px; }
        .card p { font-size: 15px; line-height: 1.7; margin-bottom: 12px; }

        #input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            z-index: 5;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 0;
            transform: translateY(100%);
        }

        #input-area.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .input-wrapper {
            max-width: 480px;
            margin: 0 auto;
        }

        .input-group input, .input-group textarea {
            width: 100%; padding: 14px 18px; border: 2px solid var(--accent-color);
            border-radius: 25px; font-size: 15px; background: var(--card-bg); color: var(--card-text);
        }
        
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--card-text); }
        .input-group textarea { border-radius: 15px; min-height: 100px; }
        
        .card-input-area {
            margin-top: 20px;
        }

        .radio-option, .checkbox-option {
            display: flex; align-items: center; padding: 10px;
            border: 2px solid transparent; border-radius: 15px;
            cursor: pointer; transition: background-color 0.3s ease;
            background: transparent; 
            color: var(--card-text);
        }
        .radio-option:hover, .checkbox-option:hover { background: rgba(225, 221, 240, 0.5); }
        
        .radio-option input, .checkbox-option input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            -webkit-appearance: none;
            appearance: none;
        }
        .custom-control {
            position: relative; width: 24px; height: 24px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            margin-right: 12px; flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .marker-x {
            width: 100%; height: 100%;
        }
        .marker-x .line {
            stroke: var(--marker-color); stroke-width: 3; stroke-linecap: round;
            stroke-dasharray: 25; stroke-dashoffset: 25;
            transition: stroke-dashoffset 0.4s cubic-bezier(0.455, 0.030, 0.515, 0.955);
        }
        .selected .marker-x .line1 { stroke-dashoffset: 0; transition-delay: 0s; }
        .selected .marker-x .line2 { stroke-dashoffset: 0; transition-delay: 0.2s; }

        .action-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .btn {
            flex: 1; padding: 14px 20px; border: none; border-radius: 25px;
            font-size: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .btn-primary { background: var(--btn-bg); color: white; }
        .btn-secondary { background: var(--accent-color); color: var(--card-text); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .character-counter { color: var(--accent-color); margin-top: 8px; font-size: 12px; text-align: right; line-height: 1.4; }
        .error-message-inline { color: #ff8a80; font-size: 13px; margin-top: 8px; text-align: center; width: 100%; }
        .input-group { margin-bottom: 15px; }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 4px; } /* Reduced gap */
        .radio-option label, .checkbox-option label { font-size: 14px; cursor: pointer; line-height: 1.4; }
        
        .summary-section {
            background: transparent;
            padding: 10px;
            border-radius: 15px;
            color: var(--card-text);
            border: 2px dashed var(--accent-color);
        }
        .summary-section h3 { color: var(--card-text); margin-bottom: 10px; }
        .summary-label { color: var(--accent-color); font-weight: 600; }
        .summary-value { color: var(--card-text); }
        .summary-item { 
            display: flex; justify-content: space-between; padding: 10px; 
            border-bottom: 1px solid rgba(144, 134, 180, 0.3);
            cursor: pointer; border-radius: 8px; transition: background-color 0.2s ease;
        }
        .summary-item:hover { background-color: rgba(225, 221, 240, 0.8); }
        .summary-item:last-child { border: none; }
        .summary-value.truncated { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }

        @media (max-width: 600px) {
            .card { padding: 25px; }
            .card h2 { font-size: 1.8em; }
            .card p { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="parallax-bg">
            <img src="https://www.jaimesiva.com/wp-content/uploads/2025/08/short-scaled.png" alt="Shorts" class="parallax-item" data-depth="0.3" style="width: 650px; height: auto;">
            <img src="https://www.jaimesiva.com/wp-content/uploads/2025/08/gorrofondo-scaled.png" alt="Gorro" class="parallax-item" data-depth="0.6" style="width: 250px; height: auto;">
            <img src="https://www.jaimesiva.com/wp-content/uploads/2025/08/Guante.png" alt="Guante" class="parallax-item" data-depth="0.8" style="width: 250px; height: auto;">
        </div>

        <div id="card-stage">
            <!-- Las tarjetas se generarán aquí -->
        </div>

        <div id="input-area">
            <div class="input-wrapper">
                <!-- El contenido del input se generará aquí -->
            </div>
        </div>
    </div>
    
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <clipPath id="torn-paper" clipPathUnits="objectBoundingBox">
                <path d="M0.01,0.06 C0.01,0.06 0.02,0.01 0.04,0.02 C0.06,0.03 0.07,0.01 0.09,0.01 C0.11,0.01 0.12,0.03 0.14,0.02 C0.16,0.01 0.18,0.04 0.2,0.03 C0.22,0.02 0.24,0.04 0.26,0.04 C0.28,0.04 0.3,0.02 0.32,0.03 C0.34,0.04 0.36,0.02 0.38,0.02 C0.4,0.02 0.41,0.04 0.43,0.04 C0.45,0.04 0.47,0.01 0.49,0.02 C0.51,0.03 0.53,0.01 0.55,0.01 C0.57,0.01 0.58,0.03 0.6,0.03 C0.62,0.03 0.64,0.01 0.66,0.02 C0.68,0.03 0.7,0.01 0.72,0.01 C0.74,0.01 0.75,0.04 0.77,0.03 C0.79,0.02 0.81,0.04 0.83,0.04 C0.85,0.04 0.87,0.02 0.89,0.03 C0.91,0.04 0.93,0.02 0.95,0.02 C0.97,0.02 0.98,0.05 1,0.04 L0.96,0.99 C0.96,0.99 0.98,0.96 0.96,0.95 C0.94,0.94 0.93,0.97 0.91,0.96 C0.89,0.95 0.88,0.98 0.86,0.97 C0.84,0.96 0.82,0.99 0.8,0.98 C0.78,0.97 0.76,1 0.74,0.99 C0.72,0.98 0.7,0.95 0.68,0.96 C0.66,0.97 0.65,0.95 0.63,0.95 C0.61,0.95 0.59,0.97 0.57,0.97 C0.55,0.97 0.54,0.95 0.52,0.96 C0.5,0.97 0.48,0.95 0.46,0.95 C0.44,0.95 0.42,0.98 0.4,0.97 C0.38,0.96 0.37,0.99 0.35,0.98 C0.33,0.97 0.31,1 0.29,0.99 C0.27,0.98 0.25,0.95 0.23,0.96 C0.21,0.97 0.2,0.95 0.18,0.95 C0.16,0.95 0.14,0.97 0.12,0.97 C0.1,0.97 0.09,0.95 0.07,0.96 C0.05,0.97 0.03,0.95 0.01,0.96 C-0.01,0.97 0.01,0.99 0,1 L0.01,0.06z"/>
            </clipPath>
        </defs>
    </svg>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentStep = 0;
            const cardElements = [];
            const formData = {
                acceptTerms: false, name: '', email: '', gender: '', orientation: '', story: '', timestamp: null
            };

            const questions = [
                { id: 'terms', type: 'checkbox', message: `<h2>¿Tienes una historia que nunca te atreviste a contar?</h2><p>Este es tu momento. Comparte conmigo ese secreto, esa anécdota, esa experiencia guardada. Tu privacidad está completamente protegida.</p><p><em>Haz clic para aceptar los términos y comenzar este viaje.</em></p>`, options: [{ value: 'accept', label: 'He leído y acepto los términos y condiciones' }], required: true, buttonText: 'Aceptar y continuar' },
                { id: 'name', type: 'text', message: `<h2>Dime tu nombre, o un apodo</h2><p><em>Lo usaré solo para asegurar que mi interpretación no coincida con el tuyo por casualidad.</em></p>`, placeholder: 'Escribe tu nombre o apodo...', required: true, buttonText: 'Continuar' },
                { id: 'email', type: 'email', message: `<h2>¿Cuál es tu correo electrónico?</h2><p><em>Es solo para enviarte la interpretación de tu historia. Nada más.</em></p>`, placeholder: 'correo@ejemplo.com', required: true, buttonText: 'Continuar' },
                { id: 'gender', type: 'radio', message: `<h2>Género</h2><p><em>Esto me ayuda a usar los pronombres adecuados al escribir para ti.</em></p>`, options: [{ value: 'masculino', label: 'Masculino' }, { value: 'femenino', label: 'Femenino' }, { value: 'neutro', label: 'Neutro' }], required: true, buttonText: 'Continuar' },
                { id: 'orientation', type: 'radio', message: `<h2>Orientación sexual</h2><p><em>Compartir esto es opcional, pero ayuda a comprender mejor las diversas experiencias humanas.</em></p>`, options: [{ value: 'heterosexual', label: 'Heterosexual' }, { value: 'homosexual', label: 'Homosexual' }, { value: 'bisexual', label: 'Bisexual' }, { value: 'pansexual', label: 'Pansexual' }, { value: 'asexual', label: 'Asexual' }, { value: 'demisexual', label: 'Demisexual' }, { value: 'prefiero no decir', label: 'Prefiero no decirlo.'}], required: true, buttonText: 'Continuar' },
                { id: 'story', type: 'textarea', message: `<h2>Tu historia secreta</h2><p><em>Este es un espacio seguro. Lo que escribas aquí no será divulgado de forma literal. Intenta que tenga al menos 140 caracteres.</em></p>`, placeholder: 'Comparte tu historia aquí...', required: true, minLength: 140, buttonText: 'Continuar' },
                { id: 'summary', type: 'summary', message: `<h2>Revisa tu información</h2><p><em>Confirma que todo está correcto. Puedes hacer clic en una respuesta para volver y editarla.</em></p>`, buttonText: 'Cerrar el cajón y enviar' },
                { id: 'thanks', type: 'final', message: `<h2>Gracias por tu confianza</h2><p>Has guardado tu historia en un lugar seguro. Ha sido un acto de valentía compartirla.</p><p><em>Pronto recibirás un correo con mi interpretación.</em></p>` }
            ];
            
            function initializeCards() {
                const stage = document.getElementById('card-stage');
                questions.forEach((q, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.step = index;
                    card.innerHTML = `<div class="card-content">${q.message}</div>`;
                    stage.appendChild(card);
                    cardElements.push(card);
                });
            }

            function initParallax() {
                const items = document.querySelectorAll('.parallax-item');
                const container = document.getElementById('app-container');

                items.forEach(item => {
                    const width = item.clientWidth;
                    const height = item.clientHeight;
                    const randomTop = Math.random() * (container.clientHeight - height);
                    const randomLeft = Math.random() * (container.clientWidth - width);
                    const randomRotate = (Math.random() - 0.5) * 40; // -20 to 20 degrees
                    item.style.top = `${randomTop}px`;
                    item.style.left = `${randomLeft}px`;
                    item.style.transform = `rotate(${randomRotate}deg)`;
                    item.dataset.rotate = randomRotate;
                });

                const moveItems = (x, y) => {
                    items.forEach(item => {
                        const depth = item.dataset.depth;
                        const initialRotate = parseFloat(item.dataset.rotate);
                        const moveX = (x * depth) / 2;
                        const moveY = (y * depth) / 2;
                        item.style.transform = `translateX(${moveX}px) translateY(${moveY}px) rotate(${initialRotate}deg)`;
                    });
                };

                container.addEventListener('mousemove', (e) => {
                    const x = (e.clientX - window.innerWidth / 2);
                    const y = (e.clientY - window.innerHeight / 2);
                    moveItems(x, y);
                });

                window.addEventListener('deviceorientation', (e) => {
                    const y = e.beta * 5;  // -180 to 180
                    const x = e.gamma * 5; // -90 to 90
                    moveItems(x, y);
                });
            }

            function updateCardDisplay() {
                const inputArea = document.getElementById('input-area');
                
                cardElements.forEach((card, index) => {
                    card.classList.remove('is-active', 'is-exiting');
                    if (index === currentStep) card.classList.add('is-active');
                    else if (index < currentStep) card.classList.add('is-exiting');
                });
                
                const question = questions[currentStep];
                if (question.type === 'final') {
                    inputArea.classList.remove('is-visible');
                } else {
                    renderInteractionAreas(question);
                    setTimeout(() => inputArea.classList.add('is-visible'), 100);
                }
            }

            function renderInteractionAreas(question) {
                const activeCard = cardElements[currentStep];
                const cardContent = activeCard.querySelector('.card-content');
                const inputWrapper = document.querySelector('#input-area .input-wrapper');

                activeCard.querySelector('.card-input-area')?.remove();
                inputWrapper.innerHTML = '';

                let cardInputHtml = '';
                let bottomInputHtml = '';
                
                const markerSvg = `<svg class="marker-x" viewBox="0 0 20 20"><path class="line line1" d="M4,4 L16,16" /><path class="line line2" d="M16,4 L4,16" /></svg>`;
                const summaryItems = [
                    { label: 'Nombre', key: 'name' }, { label: 'Email', key: 'email' },
                    { label: 'Género', key: 'gender' }, { label: 'Orientación', key: 'orientation' },
                    { label: 'Historia', key: 'story' }
                ];

                switch (question.type) {
                    case 'text': case 'email':
                        bottomInputHtml += `<div class="input-group"><input type="${question.type}" id="textInput" placeholder="${question.placeholder}" value="${formData[question.id] || ''}"></div>`;
                        break;
                    case 'textarea':
                        bottomInputHtml += `<div class="input-group"><textarea id="textInput" placeholder="${question.placeholder}">${formData[question.id] || ''}</textarea><div class="character-counter" id="charCounter"></div></div>`;
                        break;
                    case 'radio': case 'checkbox':
                        const groupClass = question.type + '-group';
                        const optionClass = question.type + '-option';
                        const optionsHtml = question.options.map((opt, i) => {
                            const isSelected = formData[question.id] === opt.value || (Array.isArray(formData[question.id]) && formData[question.id].includes(opt.value));
                            return `<div class="${optionClass} ${isSelected ? 'selected' : ''}" onclick="selectOption(this, '${question.type}')">
                                <input type="${question.type}" name="${question.id}" value="${opt.value}" id="option_${i}" ${isSelected ? 'checked' : ''}>
                                <span class="custom-control">${markerSvg}</span>
                                <label for="option_${i}">${opt.label}</label>
                            </div>`;
                        }).join('');
                        cardInputHtml = `<div class="card-input-area"><div class="${groupClass}">${optionsHtml}</div></div>`;
                        break;
                    case 'summary':
                        const summaryHtml = summaryItems.map(item => {
                            const stepIndex = questions.findIndex(q => q.id === item.key);
                            return `<div class="summary-item" onclick="jumpToStep(${stepIndex})">
                                <span class="summary-label">${item.label}:</span>
                                <span class="summary-value truncated" title="${formData[item.key]}">${formData[item.key] || 'No especificado'}</span>
                            </div>`;
                        }).join('');
                        cardInputHtml = `<div class="card-input-area"><div class="summary-section"><h3>Tu Resumen</h3>${summaryHtml}</div></div>`;
                        break;
                }

                if (cardInputHtml) {
                    cardContent.insertAdjacentHTML('beforeend', cardInputHtml);
                }
                
                const backButton = currentStep > 0 ? `<button class="btn btn-secondary" onclick="handleBack()">Atrás</button>` : '';
                inputWrapper.innerHTML = `${bottomInputHtml}<div id="error-message" class="error-message-inline"></div><div class="action-buttons">${backButton}<button id="nextBtn" class="btn btn-primary">${question.buttonText}</button></div>`;
                
                document.getElementById('nextBtn').onclick = handleNext;

                if (question.type === 'textarea') {
                    const textarea = document.getElementById('textInput');
                    const charCounter = document.getElementById('charCounter');
                    const nextBtn = document.getElementById('nextBtn');
                    const updateCounter = () => {
                        const len = textarea.value.length;
                        const min = question.minLength;
                        if (len < min) {
                            charCounter.textContent = "Escribe al menos 140 caracteres. Una vez alcanzada la cantidad mínima, puedes continuar tu historia sin límite.";
                            nextBtn.disabled = true;
                        } else {
                            charCounter.textContent = `${len} caracteres`;
                            nextBtn.disabled = false;
                        }
                    };
                    textarea.addEventListener('input', updateCounter);
                    updateCounter();
                }
            }
            
            window.selectOption = (element, type) => {
                if (type === 'radio') {
                    element.parentElement.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
                    element.classList.add('selected');
                } else {
                    element.classList.toggle('selected');
                }
                element.querySelector('input').checked = element.classList.contains('selected');
            };

            window.handleBack = () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateCardDisplay();
                }
            };
            
            window.jumpToStep = (step) => {
                currentStep = step;
                updateCardDisplay();
            };

            async function handleNext() {
                const question = questions[currentStep];
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = '';
                let value;

                switch (question.type) {
                    case 'text': case 'email': case 'textarea':
                        const input = document.getElementById('textInput');
                        value = input.value.trim();
                        if (question.required && !value) { errorDiv.textContent = 'Este campo es obligatorio.'; return; }
                        if (question.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { errorDiv.textContent = 'Por favor, ingresa un correo válido.'; return; }
                        if (question.minLength && value.length < question.minLength) { errorDiv.textContent = `Debe tener al menos ${question.minLength} caracteres.`; return; }
                        break;
                    case 'radio':
                        const radio = document.querySelector(`input[name="${question.id}"]:checked`);
                        if (question.required && !radio) { errorDiv.textContent = 'Debes seleccionar una opción.'; return; }
                        value = radio ? radio.value : '';
                        break;
                    case 'checkbox':
                        const cb = document.querySelector(`input[name="${question.id}"]:checked`);
                        if (question.required && !cb) { errorDiv.textContent = 'Debes aceptar los términos.'; return; }
                        value = 'accept';
                        break;
                    case 'summary':
                        await handleSubmit(); return;
                }

                formData[question.id] = value;
                document.getElementById('input-area').classList.remove('is-visible');
                setTimeout(() => {
                    currentStep++;
                    updateCardDisplay();
                }, 400);
            };

            async function handleSubmit() {
                const submitBtn = document.getElementById('nextBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
                formData.timestamp = new Date().toISOString();
                
                // Google Apps Script URL
                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNudoEgdQOPERMiSAXcd6E5ggddzIfrt5zLf5rt-1SjJsDnEx_4RBH_TT6p4_--cAtrA/exec";

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Important for simple deployments
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    console.log("Datos enviados a Google Sheets.");
                } catch (error) {
                    console.error('Error al enviar a Google Sheets:', error);
                } finally {
                    document.getElementById('input-area').classList.remove('is-visible');
                    setTimeout(() => {
                        currentStep++;
                        updateCardDisplay();
                    }, 400);
                }
            }

            initializeCards();
            updateCardDisplay();
            initParallax();
        });
    </script>
</body>
</html>
